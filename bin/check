#!/usr/bin/env ruby
# frozen_string_literal: true

# flush output immediately
$stdout.sync = true

require "bundler/setup"
require "find"
require "rubygems"
require "trollop"

require File.expand_path("../../lib/check.rb", __FILE__)
require File.expand_path("../../lib/util.rb", __FILE__)

# If there are no options given, invoke help
ARGV << "-h" if ARGV.empty?

options = Trollop.options do
  banner <<~EOS
    Command line interface to metadata-ci validation tools

    Usage:
      check [options] -f <files>

  EOS

  opt :files, "Metadata files/directories to validate", type: :strings
  opt :with, "Only run the specified checks", type: :strings
  opt :without, "Skip the specified checks", type: :strings
end

if options[:with] && options[:without]
  $stderr.puts "[ERROR] Cannot combine --with and --without"
  exit 1
end

all_checks = Dir.glob(
  File.expand_path("../../lib/check/*.rb", __FILE__)
).map do |f|
  next unless /\.rb$/ =~ f
  File.basename(f).sub(/\.rb$/, "").split("_").map(&:capitalize).join
end

used_checks = if options[:with]
                all_checks & options[:with]
              elsif options[:without]
                all_checks - options[:without]
              else
                all_checks
              end

if used_checks.empty?
  $stderr.puts <<~EOS
    [ERROR] No valid checks specified.  Allowed checks are
    * #{all_checks.join("\n* ")}
    EOS
  exit 1
end

data = Util.find_paths(options[:files])

$stderr.puts Util.bold("Running checks: #{used_checks.join(", ")}")
$stderr.puts

errors = used_checks.map do |ch|
  begin
    Object.const_get("Check::#{ch}").batch(data)
  rescue NameError
    $stderr.puts "[ERROR] No check '#{ch}' defined"
    exit 1
  end
end.flatten.sort_by(&:file)

if errors.empty?
  puts "No errors found!"
  exit 0
end

$stderr.puts(errors.map do |e|
  <<~EOS
    * #{Util.bold(e.file)}:
      #{e.problem}

  EOS
end.join(""))

exit 1
